<!-- games/color-memory.html -->
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>üé® Color Memory</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white min-h-screen flex items-center justify-center text-gray-800 p-4"><div class="flex flex-col lg:flex-row gap-8 max-w-7xl w-full"><div class="flex-1 bg-white p-6 shadow-xl rounded-2xl border border-blue-200">
<div class="text-green-600 font-semibold mb-3" id="best-score">Your Best Score: loading...</div><header class="p-4 border-b border-blue-200 bg-white flex justify-between items-center">
<h1 class="text-xl font-bold text-blue-600">üé® Color Memory</h1>
<button class="text-sm text-blue-500 underline" onclick="goBack()">Back</button>
</header>
<main class="p-6 max-w-xl mx-auto text-center space-y-6">
<p class="text-sm text-gray-600">Memorize the color sequence and then repeat it!</p>
<div class="flex justify-center gap-4 flex-wrap" id="sequence"></div>
<button class="bg-blue-600 text-white px-4 py-2 rounded font-semibold" id="start-btn" onclick="startGame()">Start</button>
<div class="text-lg font-semibold hidden" id="feedback"></div>
</main>
<script>
    const colors = ["red", "blue", "green", "yellow"];
    const sequenceEl = document.getElementById("sequence");
    const feedback = document.getElementById("feedback");
    const userLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    const loggedInUserId = localStorage.getItem("userId");

    let colorSequence = [];
    let userSequence = [];
    let listening = false;
    let score = 0;

    function startGame() {
      colorSequence = [];
      userSequence = [];
      score = 0;
      feedback.classList.add("hidden");
      document.getElementById("start-btn").disabled = true;
      generateSequence(1);
    }

    function generateSequence(length) {
      for (let i = 0; i < length; i++) {
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        colorSequence.push(randomColor);
      }
      displaySequence();
    }

    function displaySequence() {
      sequenceEl.innerHTML = "";
      colorSequence.forEach((color, index) => {
        const div = document.createElement("div");
        div.className = `w-12 h-12 rounded-full bg-${color}-500 opacity-50`;
        sequenceEl.appendChild(div);
        setTimeout(() => {
          div.classList.add("opacity-100");
        }, index * 600);
        setTimeout(() => {
          div.classList.remove("opacity-100");
        }, index * 600 + 400);
      });

      setTimeout(() => {
        renderInputButtons();
        listening = true;
      }, colorSequence.length * 600 + 600);
    }

    function renderInputButtons() {
      sequenceEl.innerHTML = "";
      colors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = `w-16 h-16 rounded-full bg-${color}-500 hover:opacity-75`;
        btn.onclick = () => handleUserClick(color);
        sequenceEl.appendChild(btn);
      });
    }

    function handleUserClick(color) {
      if (!listening) return;
      userSequence.push(color);
      const currentIndex = userSequence.length - 1;

      if (userSequence[currentIndex] !== colorSequence[currentIndex]) {
        feedback.textContent = "‚ùå Wrong Sequence! Final score: " + score;
        feedback.className = "text-red-600 text-lg font-semibold";
        feedback.classList.remove("hidden");
        document.getElementById("start-btn").disabled = false;
        listening = false;

        // üîê Save score if user is logged in
        if (userLoggedIn && loggedInUserId) {
          fetch("/api/brain-games/update-score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: loggedInUserId,
              gameId: "color-memory",
              score: score
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log("‚úÖ Score saved to backend:", data.bestScore);
            } else {
              console.error("‚ùå Score save failed:", data.message);
            }
          })
          .catch(err => console.error("‚ùå Network error:", err));
        }
        return;
      }

      if (userSequence.length === colorSequence.length) {
        score++;
        feedback.textContent = "‚úÖ Good Memory! Get ready for next round.";
        feedback.className = "text-green-600 text-lg font-semibold";
        feedback.classList.remove("hidden");
        setTimeout(() => {
          userSequence = [];
          listening = false;
          generateSequence(1);
        }, 1200);
      }
    }

    function goBack() {
      window.location.href = '../braingames.html';
    }
  </script>
</div>
<div class="w-full lg:w-72 bg-gray-50 border border-gray-200 p-4 rounded-xl shadow">
<h2 class="font-bold mb-3 text-blue-700">üèÜ Leaderboard</h2>
<ul class="text-sm text-gray-700 space-y-2" id="leaderboard"></ul>
</div>
</div><script>
    const API_BASE = "http://localhost:5000/api/brain-games"; // Change to your deployed backend

    const username = localStorage.getItem("username");
    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

    async function fetchUserBestScore(gameId) {
      try {
        const res = await fetch(`${API_BASE}/user?username=${username}&gameId=${gameId}`);
        const data = await res.json();
        document.getElementById("best-score").textContent = `Your Best Score: ${data.score || 0}`;
      } catch {
        document.getElementById("best-score").textContent = "Login to track score.";
      }
    }

    async function fetchLeaderboard(gameId) {
      try {
        const res = await fetch(`${API_BASE}/top?gameId=${gameId}`);
        const data = await res.json();
        const lb = document.getElementById("leaderboard");
        lb.innerHTML = data.map((s, i) => `<li>${i + 1}. ${s.username} ‚Äì ${s.score}</li>`).join("");
      } catch {
        document.getElementById("leaderboard").innerHTML = "<li>Could not load leaderboard.</li>";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      const gameId = window.location.pathname.split("/").pop().replace(".html", "");
      if (isLoggedIn && username) {
        fetchUserBestScore(gameId);
        fetchLeaderboard(gameId);
      } else {
        const bs = document.getElementById("best-score");
        if (bs) bs.textContent = "Login to track score.";
      }
    });
    </script></body>
</html>

<!-- games/color-memory.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎨 Color Memory</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black min-h-screen">
  <header class="p-4 border-b border-blue-200 bg-white flex justify-between items-center">
    <h1 class="text-xl font-bold text-blue-600">🎨 Color Memory</h1>
    <button onclick="goBack()" class="text-sm text-blue-500 underline">Back</button>
  </header>

  <main class="p-6 max-w-xl mx-auto text-center space-y-6">
    <p class="text-sm text-gray-600">Memorize the color sequence and then repeat it!</p>

    <div id="sequence" class="flex justify-center gap-4 flex-wrap"></div>

    <button onclick="startGame()" id="start-btn" class="bg-blue-600 text-white px-4 py-2 rounded font-semibold">Start</button>

    <div id="feedback" class="text-lg font-semibold hidden"></div>
  </main>

  <script>
    const colors = ["red", "blue", "green", "yellow"];
    const sequenceEl = document.getElementById("sequence");
    const feedback = document.getElementById("feedback");
    const userLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    const loggedInUserId = localStorage.getItem("userId");

    let colorSequence = [];
    let userSequence = [];
    let listening = false;
    let score = 0;

    function startGame() {
      colorSequence = [];
      userSequence = [];
      score = 0;
      feedback.classList.add("hidden");
      document.getElementById("start-btn").disabled = true;
      generateSequence(1);
    }

    function generateSequence(length) {
      for (let i = 0; i < length; i++) {
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        colorSequence.push(randomColor);
      }
      displaySequence();
    }

    function displaySequence() {
      sequenceEl.innerHTML = "";
      colorSequence.forEach((color, index) => {
        const div = document.createElement("div");
        div.className = `w-12 h-12 rounded-full bg-${color}-500 opacity-50`;
        sequenceEl.appendChild(div);
        setTimeout(() => {
          div.classList.add("opacity-100");
        }, index * 600);
        setTimeout(() => {
          div.classList.remove("opacity-100");
        }, index * 600 + 400);
      });

      setTimeout(() => {
        renderInputButtons();
        listening = true;
      }, colorSequence.length * 600 + 600);
    }

    function renderInputButtons() {
      sequenceEl.innerHTML = "";
      colors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = `w-16 h-16 rounded-full bg-${color}-500 hover:opacity-75`;
        btn.onclick = () => handleUserClick(color);
        sequenceEl.appendChild(btn);
      });
    }

    function handleUserClick(color) {
      if (!listening) return;
      userSequence.push(color);
      const currentIndex = userSequence.length - 1;

      if (userSequence[currentIndex] !== colorSequence[currentIndex]) {
        feedback.textContent = "❌ Wrong Sequence! Final score: " + score;
        feedback.className = "text-red-600 text-lg font-semibold";
        feedback.classList.remove("hidden");
        document.getElementById("start-btn").disabled = false;
        listening = false;

        // 🔐 Save score if user is logged in
        if (userLoggedIn && loggedInUserId) {
          fetch("/api/brain-games/update-score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: loggedInUserId,
              gameId: "color-memory",
              score: score
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log("✅ Score saved to backend:", data.bestScore);
            } else {
              console.error("❌ Score save failed:", data.message);
            }
          })
          .catch(err => console.error("❌ Network error:", err));
        }
        return;
      }

      if (userSequence.length === colorSequence.length) {
        score++;
        feedback.textContent = "✅ Good Memory! Get ready for next round.";
        feedback.className = "text-green-600 text-lg font-semibold";
        feedback.classList.remove("hidden");
        setTimeout(() => {
          userSequence = [];
          listening = false;
          generateSequence(1);
        }, 1200);
      }
    }

    function goBack() {
      window.location.href = '../braingames.html';
    }
  </script>
</body>
</html>
